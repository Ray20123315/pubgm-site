<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PUBGM 好友推薦及LINE社群</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; padding: 0 10px; }
    header, main, footer { margin-bottom: 30px; }
    h1, h2 { text-align: center; }
    .btn {
      display: inline-block;
      padding: 10px 20px;
      margin: 5px auto;
      background-color: #00c300;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      text-align: center;
    }
    #teammate-list {
      margin-top: 10px;
    }
    .teammate-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 12px;
      background: #f9f9f9;
    }
    .teammate-card h3 {
      margin: 0 0 6px 0;
    }
  </style>
</head>
<body>
  <header>
    <h1>🎯 PUBGM 好友推薦及LINE社群</h1>
    <p style="text-align:center;">歡迎來到PUBGM好友推薦及LINE社群！聚集戰友、分享技巧。</p>
    <div style="text-align:center;">
      <a href="https://line.me/ti/g2/3R7YozDVnTR4ln5XjtR7tlxcMnloRpnggGwEng?utm_source=invitation&utm_medium=link_copy&utm_campaign=default" target="_blank" class="btn">加入 LINE 社群</a>
      <a href="https://forms.gle/qtwE592qaeD4Girv6" target="_blank" class="btn">填寫推薦表單</a>
    </div>
  </header>

  <main>
    <h2>好友推薦牆</h2>
    <div id="teammate-list">載入中...</div>
  </main>

  <footer style="text-align:center; color:#888;">
    <p>© 2025 PUBGM 好友推薦牆</p>
  </footer>

  <!-- 載入 PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR4C-YNnRgX3N71kURyPYn0K6Gt34uLFPm5DjiWzHf9DfKDzE3LIoEm2D8SqZoyrXycU4cIDK7qlgLd/pub?output=csv";

    function clean(value) {
      if (!value) return "";
      return value.toString()
        .trim()
        .replace(/^"+|"+$/g, "")
        .replace(/\r?\n/g, " ")
        .replace(/\s+/g, " ");
    }

    function findKey(obj, keyword) {
      const keys = Object.keys(obj);
      for (let key of keys) {
        if (key.replace(/\s/g, '').includes(keyword.replace(/\s/g, ''))) {
          return key;
        }
      }
      return null;
    }

    function parseTimeText(str) {
      if (!str) return [];
      let cleanStr = str.replace(/^"+|"+$/g, "").replace(/\r?\n/g, " ").trim();
      let parts = cleanStr.split(/[,、\s]+/);
      let unique = [...new Set(parts.filter(s => s && s !== "不玩"))];
      return unique;
    }

    function displayTeammates(data) {
      const container = document.getElementById("teammate-list");
      container.innerHTML = "";

      if (!data || data.length === 0) {
        container.innerHTML = "<p>目前沒有推薦的隊友。</p>";
        return;
      }

      const weekDays = ["一", "二", "三", "四", "五", "六", "日"];

      data.forEach(item => {
        const idKey = findKey(item, "隊友ID") || findKey(item, "隊友 ID");
        const uidKey = findKey(item, "隊友UID") || findKey(item, "隊友 UID");
        const roleKey = findKey(item, "擅長角色") || findKey(item, "擅長扮演角色");
        const techKey = findKey(item, "技術類型") || findKey(item, "技術類型(自評)");
        const noteKey = findKey(item, "想補充") || findKey(item, "備註");
        const satisfactionKey = findKey(item, "滿意度");
        const likeKey = findKey(item, "喜愛度");

        const id = idKey ? clean(item[idKey]) : "";
        const uid = uidKey ? clean(item[uidKey]) : "";
        const displayID = id ? id : `(UID: ${uid})`;

        let timesText = "";
        for (let i = 0; i < 7; i++) {
          const dayKey1 = `平常遊玩時間(若當天不玩請填寫不玩) [星期${weekDays[i]}]`;
          const dayKey2 = findKey(item, `星期${weekDays[i]}`);
          const key = item.hasOwnProperty(dayKey1) ? dayKey1 : (dayKey2 || "");
          const valRaw = key ? clean(item[key]) : "";
          const times = parseTimeText(valRaw);
          if (times.length > 0) {
            timesText += `　${weekDays[i]}：${times.join(", ")}<br>`;
          }
        }

        const card = document.createElement("div");
        card.className = "teammate-card";
        card.innerHTML = `
          <h3>🆔 ${displayID}</h3>
          <p>🎯 擅長角色：${roleKey ? clean(item[roleKey]) : "無"}</p>
          <p>📊 技術評價：${techKey ? clean(item[techKey]) : "無"}</p>
          <p>🕐 出沒時間：<br>${timesText || "無資料"}</p>
          <p>💬 備註：${noteKey ? clean(item[noteKey]) : "無"}</p>
          <p>⭐ 滿意度：${satisfactionKey ? clean(item[satisfactionKey]) : "無"}</p>
          <p>💖 喜愛度：${likeKey ? clean(item[likeKey]) : "無"}</p>
        `;
        container.appendChild(card);
      });
    }

    Papa.parse(sheetURL, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        console.log("欄位名稱:", Object.keys(results.data[0]));
        console.log("第一筆資料:", results.data[0]);
        displayTeammates(results.data);
      },
      error: function(err) {
        console.error(err);
        document.getElementById("teammate-list").innerHTML = "<p>資料解析錯誤，請稍後再試。</p>";
      }
    });
  </script>
</body>
</html>
